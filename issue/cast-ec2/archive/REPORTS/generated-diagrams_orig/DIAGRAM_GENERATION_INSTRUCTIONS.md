# AWS Architecture Diagram Generation Instructions

## Overview

This folder contains AWS architecture diagrams that were **automatically generated from the Terraform code** in this project using AI analysis and the `awslabs.aws-diagram-mcp-server` MCP tool.

**Key Point:** These diagrams are NOT manually drawn. They are generated by having AI analyze your Terraform files and infer the architecture, access patterns, and relationships between resources.

---

## MCP Tool Used

**Tool:** `awslabs.aws-diagram-mcp-server`  
**Type:** Python-based MCP server using the `diagrams` package  
**Transport:** `uvx` (Python package runner)

### Verify Tool is Configured

Check that this is in your `~/.cursor/mcp.json`:

```json
{
  "mcpServers": {
    "awslabs.aws-diagram-mcp-server": {
      "command": "uvx",
      "args": ["awslabs.aws-diagram-mcp-server"],
      "env": {
        "FASTMCP_LOG_LEVEL": "ERROR"
      },
      "autoApprove": [],
      "disabled": false
    }
  }
}
```

**Status Check:** `disabled: false` means it's active and ready to use.

---

## Prerequisites

### 1. Install Graphviz (Required)

```bash
# macOS
brew install graphviz

# Verify installation
which dot
dot -V
# Should show: dot - graphviz version 14.0.2 (or similar)
```

### 2. Install uv (Python Package Manager)

```bash
brew install uv
```

### 3. Restart Cursor

After installing dependencies or modifying MCP configuration, quit and restart Cursor completely.

---

## How AI Inference Works

### What AI Analyzes

When you ask for diagrams, AI reads your Terraform files and infers semantic meaning:

#### From IAM Policies → Access Patterns

**Terraform Code:**
```hcl
# iam.tf
resource "aws_iam_role_policy_attachment" "ssm_managed_instance_core" {
  role       = aws_iam_role.cast_instance_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
}
```

**AI Inference:**
- "This instance has SSM managed instance core policy"
- "That means Systems Manager Session Manager is the access method"
- "So the flow is: Administrator → Session Manager → EC2 Instance"

**Generated Diagram Element:**
```python
admin = User("Administrator")
ssm = SystemsManager("Session Manager")
instance = EC2("CAST Instance")

admin >> Edge(label="SSM access") >> ssm >> instance
```

#### From Policies → Cross-Account Access

**Terraform Code:**
```hcl
# iam.tf
data "aws_iam_policy_document" "cross_account_ami_access" {
  statement {
    actions = ["ec2:DescribeImages"]
    resources = ["*"]
    condition {
      test     = "StringEquals"
      variable = "ec2:Owner"
      values   = ["422228628991"]  # customer-image-mgmt account
    }
  }
}
```

**AI Inference:**
- "This policy allows reading AMIs from account 422228628991"
- "That's cross-account resource access"
- "Should show this as a dotted line connection to external account"

**Generated Diagram Element:**
```python
with Cluster("CAST Account (925774240130)"):
    instance = EC2("CAST Instance")

with Cluster("customer-image-mgmt (422228628991)"):
    ami = AMI("Windows AMI")

ami >> Edge(style="dotted", label="cross-account") >> instance
```

#### From Security Groups → Network Flow

**Terraform Code:**
```hcl
# main.tf
resource "aws_security_group" "cast_sg" {
  ingress {
    from_port   = 3389
    to_port     = 3389
    protocol    = "tcp"
    cidr_blocks = ["10.0.0.0/8"]
  }
}
```

**AI Inference:**
- "Port 3389 is RDP"
- "Allowed from 10.0.0.0/8 (corporate network)"
- "This means RDP access from VPN/corporate network"

**Generated Diagram Element:**
```python
corp_network = Blank("Corporate Network\n10.0.0.0/8")
instance = EC2("CAST Instance")

corp_network >> Edge(label="RDP (3389)") >> instance
```

#### From Data Sources → Dependencies

**Terraform Code:**
```hcl
# data.tf
data "aws_vpc" "existing" {
  filter {
    name   = "tag:Name"
    values = ["BFH-MGMT-VPC"]
  }
}

data "aws_subnet" "private" {
  filter {
    name   = "tag:Name"
    values = ["BFH-MGMT-PRIVATE-AZ1"]
  }
}
```

**AI Inference:**
- "Instance is in an existing VPC named BFH-MGMT-VPC"
- "It's in a private subnet"
- "Need to show VPC and subnet hierarchy"

**Generated Diagram Element:**
```python
with Cluster("BFH-MGMT-VPC"):
    with Cluster("Private Subnet"):
        instance = EC2("CAST Instance")
```

---

## Diagrams Generated in This Folder

### 1. cast_network_flow.png (⭐ BEST EXAMPLE)

**Focus:** Network connectivity and access patterns

**Generated in:** ~4 seconds  
**Size:** 96KB

**Shows:**
- Administrator → Systems Manager → EC2 access flow
- VPC endpoints for SSM connectivity
- Transit Gateway connection to on-premises domain controllers
- CloudWatch logging flow
- Network relationships and data paths

**Inferences Made:**
- IAM SSM policy → Administrator access via Session Manager
- Transit Gateway attachment → Connection to corporate network
- CloudWatch log groups → Logging and monitoring flow
- VPC endpoints → Secure AWS service connectivity

---

### 2. cast_aws_architecture.png

**Focus:** Full AWS infrastructure overview

**Generated in:** ~7 seconds  
**Size:** 123KB

**Shows:**
- All AWS resources (EC2, EBS, IAM, Security Groups)
- Account boundaries (CAST account, customer-image-mgmt account)
- Cross-account AMI and Secrets Manager access
- IAM roles and policy attachments
- Storage volumes and attachments
- VPC and network components

**Inferences Made:**
- IAM instance profile → Role assumption by EC2
- Cross-account policies → External dependencies
- EBS volume attachments → Storage relationships
- Secrets Manager access → Credential storage pattern

---

### 3. cast_infrastructure.png

**Focus:** Core infrastructure components

**Generated in:** ~3 seconds  
**Size:** 39KB

**Shows:**
- EC2 instance with configuration
- EBS volumes
- IAM role and instance profile
- Security group
- Essential relationships

**Inferences Made:**
- Simplified view of main components
- Focus on compute and storage
- IAM role attachment pattern

---

### 4. cast_full_architecture.png

**Focus:** Detailed architecture with all components

**Generated in:** ~6 seconds  
**Size:** 119KB

**Shows:**
- Comprehensive view of all resources
- Detailed IAM policy relationships
- Network configuration details
- Cross-account access patterns

---

### 5. cast_simple.png

**Focus:** Minimal concept diagram

**Generated in:** ~2 seconds  
**Size:** 31KB

**Shows:**
- Core concept: EC2 instance with IAM role
- Minimal visualization for quick reference

---

### 6. cast_terraform_infrastructure.png

**Focus:** Initial basic attempt

**Generated in:** ~2 seconds  
**Size:** 10KB

**Shows:**
- Most basic representation
- Starting point for diagram generation

---

## How to Reproduce These Diagrams

### Quick Start: Single Command

Point AI at the CAST Terraform directory and ask:

```
@cast_directory
Create AWS architecture diagrams from this Terraform code.
```

### Specific Diagram Types

#### Network Flow Diagram (Recommended - Best for Documentation)

```
@cast_directory
Create a network flow diagram showing:
- Administrator access patterns
- Session Manager connections
- VPC endpoints
- Transit Gateway to on-premises
- CloudWatch logging flows

Use the awslabs.aws-diagram-mcp-server and save as "network_flow.png"
```

#### Full Infrastructure Diagram

```
@cast_directory
Create a comprehensive AWS architecture diagram showing all resources:
- EC2 instance with specs
- IAM roles and all policy attachments
- Cross-account access (AMI and Secrets Manager)
- Security groups and network config
- EBS volumes and attachments

Use the awslabs.aws-diagram-mcp-server and save as "full_architecture.png"
```

#### Core Infrastructure (Simple)

```
@cast_directory
Create a simple infrastructure diagram focusing only on:
- EC2 instance
- IAM role
- EBS volumes
- Security group

Keep it minimal and clear. Use the awslabs.aws-diagram-mcp-server.
```

#### Multi-Account View

```
@cast_directory
Create a diagram emphasizing cross-account relationships:
- CAST account (925774240130) resources
- customer-image-mgmt account (422228628991) AMI access
- Cross-account Secrets Manager access
- Account boundaries and connections

Use the awslabs.aws-diagram-mcp-server and save as "multi_account.png"
```

#### IAM and Security Focus

```
@cast_directory
Create a diagram focused on IAM and security:
- IAM role and instance profile
- All policy attachments (AmazonSSMManagedInstanceCore, CloudWatchLogsPolicy, AMI access, Secrets access)
- Policy documents and permissions
- Security group rules

Use the awslabs.aws-diagram-mcp-server and save as "iam_security.png"
```

---

## Advanced: Multiple Diagrams at Once

### Complete Documentation Set

```
@cast_directory
Generate a complete set of architecture diagrams:

1. network_flow.png - Network connectivity and access patterns
2. full_infrastructure.png - All AWS resources and relationships
3. core_infrastructure.png - Essential components only
4. iam_security.png - IAM roles, policies, and security
5. cross_account.png - Multi-account dependencies

For each diagram:
- Use official AWS icons
- Show clear relationships
- Label connections with purpose
- Keep it clean and professional

Use the awslabs.aws-diagram-mcp-server for all diagrams.
```

---

## What AI Automatically Infers

### Resource Relationships

| Terraform Resource | Inferred Relationship |
|--------------------|----------------------|
| `aws_iam_role_policy_attachment` | Role → Policy connection |
| `aws_iam_instance_profile` | EC2 → Role assumption |
| `aws_volume_attachment` | EC2 → EBS connection |
| `aws_security_group_rule` | Network flow direction |
| `data.aws_vpc` | VPC context and hierarchy |
| `data.aws_subnet` | Subnet placement |

### Access Patterns

| IAM Policy | Inferred Access Pattern |
|-----------|------------------------|
| `AmazonSSMManagedInstanceCore` | Administrator → SSM → EC2 |
| `CloudWatchAgentServerPolicy` | EC2 → CloudWatch Logs |
| Custom cross-account policy | Account A → Account B resources |
| Secrets Manager policy | EC2 → Secrets retrieval |

### Network Flows

| Configuration | Inferred Flow |
|--------------|--------------|
| Security Group port 3389 from 10.0.0.0/8 | Corporate Network → RDP → EC2 |
| Transit Gateway attachment | EC2 → TGW → On-premises |
| VPC endpoints | EC2 → Endpoint → AWS Service |
| CloudWatch log group | EC2 → Logs → CloudWatch |

### Semantic Understanding

| Terraform Element | AI Understanding |
|------------------|------------------|
| `AmazonSSMManagedInstanceCore` | "This enables SSM Session Manager for admin access" |
| Cross-account AMI policy | "This instance uses AMIs from another account" |
| Secrets Manager permissions | "Credentials stored in Secrets Manager" |
| Transit Gateway in data sources | "Connection to corporate network" |
| Private subnet | "Not directly internet accessible" |
| Domain join user data | "Joins Active Directory domain" |

---

## Tips for Best Results

### 1. Be Specific About Focus

❌ **Vague:** "Create a diagram"
✅ **Specific:** "Create a network flow diagram showing administrator access patterns"

### 2. Mention the MCP Tool

Always include `Use the awslabs.aws-diagram-mcp-server` to ensure the correct tool is used.

### 3. Request Multiple Perspectives

Different diagram types serve different purposes:
- **Network flow** - For operations and access documentation
- **Full infrastructure** - For architecture reviews
- **Core components** - For onboarding and quick reference
- **IAM security** - For security audits
- **Cross-account** - For multi-account strategy discussions

### 4. Iterate and Refine

First generation:
```
@cast_directory
Create a network flow diagram
```

Refinement:
```
Add labels to all connections showing the purpose (e.g., "SSM access", "domain join")
```

Further refinement:
```
Group AWS services separately from the VPC resources
```

### 5. Save Outputs

Specify filenames to organize diagrams:
```
Save as "cast_network_flow_v2.png"
```

---

## Directory Structure

```
generated-diagrams_orig/
├── DIAGRAM_GENERATION_INSTRUCTIONS.md  # This file
├── cast_network_flow.png               # ⭐ Best for documentation
├── cast_aws_architecture.png           # Full infrastructure view
├── cast_infrastructure.png             # Core components
├── cast_full_architecture.png          # Detailed everything
├── cast_simple.png                     # Minimal concept
└── cast_terraform_infrastructure.png   # Initial basic attempt
```

---

## Troubleshooting

### Diagrams Not Generating

**Check MCP Configuration:**
```bash
cat ~/.cursor/mcp.json | grep -A 10 "awslabs.aws-diagram-mcp-server"
```

Ensure `"disabled": false`

**Verify Graphviz:**
```bash
which dot
dot -V
```

If missing:
```bash
brew install graphviz
```

**Restart Cursor:**
Completely quit and restart Cursor after any configuration changes.

### Timeout Errors

Complex diagrams may timeout if they take > 90 seconds.

**Solution:** Request multiple smaller, focused diagrams instead of one huge diagram.

### Missing Resources in Diagram

The AI infers from what it sees in the Terraform files. If resources aren't shown:

1. Check that the Terraform files define those resources
2. Be more specific in your prompt about what to include
3. Verify that data sources are properly referenced

---

## Examples from This Project

### What Was Actually Generated

Here's what AI read from your Terraform files:

**From `iam.tf`:**
- IAM role: `cast_instance_role`
- Instance profile: `cast_instance_profile`
- Policy attachments: SSM, CloudWatch, custom policies
- Cross-account AMI access policy
- Cross-account Secrets Manager access policy

**From `main.tf`:**
- EC2 instance with Windows AMI
- Instance type, volume configuration
- Security group with RDP access from 10.0.0.0/8
- EBS volume attachments
- User data for domain join

**From `data.tf`:**
- VPC lookup: "BFH-MGMT-VPC"
- Subnet lookup: "BFH-MGMT-PRIVATE-AZ1"
- AMI data source from customer-image-mgmt account
- Secrets Manager ARN reference
- Transit Gateway reference

**Inferences Made:**

1. **Administrator Access:**
   - Saw `AmazonSSMManagedInstanceCore` → "Admin uses SSM Session Manager"

2. **Network Flow:**
   - Saw Transit Gateway → "Connection to corporate network"
   - Saw private subnet → "Not directly internet accessible"
   - Saw VPC endpoints (implied by SSM) → "Secure AWS service access"

3. **Cross-Account Dependencies:**
   - Saw AMI data source from 422228628991 → "Uses AMIs from customer-image-mgmt account"
   - Saw Secrets Manager access → "Retrieves domain join credentials from another account"

4. **Domain Integration:**
   - Saw user data with domain join script → "Joins Active Directory"
   - Saw Transit Gateway → "Route to domain controllers"

5. **Logging:**
   - Saw CloudWatch policy → "Sends logs to CloudWatch"

---

## Related Documentation

- **MCP Server Details:** `/Users/a805120/develop/workflows/scripts/setup/mcp-aws/hacky_successful/README_TERRAFORM_TO_DIAGRAMS.md`
- **Code Examples:** `/Users/a805120/develop/workflows/scripts/setup/mcp-aws/hacky_successful/diagram_code_examples.py`
- **What I Did (Context):** `/Users/a805120/develop/workflows/scripts/setup/mcp-aws/hacky_successful/WHAT_I_DID.md`

---

## Summary: Reproducing These Diagrams

**Simplest Approach:**
1. Tag this directory: `@cast_directory`
2. Ask: "Create AWS architecture diagrams from this Terraform code"
3. AI will analyze the Terraform files and generate professional diagrams

**For Network Flow (Like the Star Example):**
```
@cast_directory
Create a network flow diagram showing administrator access via Session Manager,
VPC endpoints, Transit Gateway to on-premises, and CloudWatch logging.
Use awslabs.aws-diagram-mcp-server.
```

**The Tool Does Everything:**
- Reads your Terraform files
- Infers resource relationships
- Understands access patterns from IAM policies
- Maps to AWS diagram icons
- Generates professional PNG diagrams
- Saves to your specified location

**Generation Time:** 2-10 seconds per diagram  
**Quality:** Production-ready with official AWS icons  
**Maintenance:** Regenerate whenever Terraform changes

---

*Generated: 2025-10-30*  
*Tool: awslabs.aws-diagram-mcp-server*  
*Method: AI analysis of Terraform infrastructure code*
